{% extends 'base.html' %} {% block content %}
<style>
  .purchase-card {
    position: relative;
    border-radius: 16px;
    padding: 1px;
    background: linear-gradient(90deg, #ff4d6d, #b5179e, #6a11cb);
    box-shadow: 0 10px 24px rgba(0, 0, 0, 0.35);
  }
  .purchase-surface {
    border-radius: 15px;
    background: #111;
    color: #fff;
    padding: 24px;
    text-align: center;
  }
  .purchase-surface h2 {
    font-weight: 800;
    margin-bottom: 12px;
  }
  .purchase-surface p {
    margin-bottom: 18px;
    font-size: 16px;
  }
  .btn-gradient {
    background: linear-gradient(90deg, #ff4d6d, #b5179e, #6a11cb);
    color: #fff !important;
    border: none !important;
    border-radius: 10px;
    font-weight: 600;
    box-shadow: 0 6px 18px rgba(106, 17, 203, 0.35);
    transition: transform 0.15s ease, box-shadow 0.2s ease, filter 0.2s ease;
    padding: 10px 20px;
    text-decoration: none;
    display: inline-block;
  }
  .btn-gradient:hover {
    filter: brightness(1.05);
    transform: translateY(-1px);
    box-shadow: 0 10px 26px rgba(106, 17, 203, 0.5);
  }
</style>
<div class="p-3">
  <div class="container">
    <div class="row mt-3">
      <div class="col-md-8 mx-auto mb-3">
        <div class="purchase-card">
          <div class="purchase-surface">
            <h2>Purchase Completed</h2>
            <hr />
            <p>
              Congratulations, your purchase has been completed.<br />
              Your order number is: <b>#{{ template_data.order_id }}</b>
            </p>
            {% if template_data.formatted_address %}
            <p>
              <strong>Location:</strong> {{ template_data.formatted_address }}
            </p>
            {% endif %}
            <a href="{% url 'accounts.orders' %}" class="btn-gradient"
              >View My Orders</a
            >

            <!-- 🗺️ Google Maps Integration -->
            <div class="mt-4">
              <h4>Your Region on the Map</h4>
              <div
                id="map"
                style="
                  height: 400px;
                  width: 100%;
                  border-radius: 12px;
                  margin-top: 12px;
                "
              ></div>
            </div>

            <!-- Google Maps API Script (API key dynamically injected from Django settings for security) -->
            <script
              src="https://maps.googleapis.com/maps/api/js?key=AIzaSyCdAAItAUZ0-LrZxyK0nhvHgFveVt8ENqE&callback=initMap"
              async
              defer
            ></script>
            <script>
              // Initialize Google Map centered on user's order location
              function initMap() {
                console.log("✅ initMap called successfully!");

                // Safely parse Django-provided values
                const latRaw = "{{ template_data.latitude|default:'' }}";
                const lngRaw = "{{ template_data.longitude|default:'' }}";

                const lat = parseFloat(latRaw);
                const lng = parseFloat(lngRaw);
                console.log("🧭 Parsed coordinates:", lat, lng);

                // Only treat missing/NaN as invalid
                if (isNaN(lat) || isNaN(lng)) {
                  document.getElementById("map").innerHTML =
                    "<p style='color:#ccc; margin-top:20px;'>Location unavailable for this order.</p>";
                  return;
                }

                const position = { lat, lng };
                console.log("📍 Using position:", position);

                // Dynamically choose zoom level based on region scale
                let zoomLevel = 10; // Default regional
                if (lat > 40 || lat < -40) zoomLevel = 11; // Slightly closer for temperate regions
                if (Math.abs(lat) < 20) zoomLevel = 8; // Wider zoom for equatorial cities

                // Create map
                const map = new google.maps.Map(
                  document.getElementById("map"),
                  {
                    zoom: zoomLevel,
                    center: position,
                  }
                );

                // Add a marker at user's location
                if (
                  google.maps.marker &&
                  google.maps.marker.AdvancedMarkerElement
                ) {
                  new google.maps.marker.AdvancedMarkerElement({
                    map,
                    position,
                    title: "Your Purchase Location",
                  });
                } else {
                  new google.maps.Marker({
                    position,
                    map,
                    title: "Your Purchase Location",
                  });
                }
              }
            </script>
          </div>
        </div>
      </div>
    </div>
  </div>
</div>
{% endblock content %}
