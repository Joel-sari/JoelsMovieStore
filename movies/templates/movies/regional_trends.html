{% extends 'base.html' %} {% load static %} {% block content %}
<!DOCTYPE html>
<html lang="en">
  <head>
    <meta charset="UTF-8" />
    <title>Regional Trends Map</title>
    <style>
      body {
        font-family: Arial, sans-serif;
        margin: 0;
        padding: 0;
        color: #fff;
      }
      .content-container {
        max-width: 1200px;
        margin: 50px auto;
        text-align: center;
        background: rgba(0, 0, 0, 0.6);
        padding: 40px;
        border-radius: 15px;
        box-shadow: 0 0 15px rgba(255, 0, 150, 0.4);
      }
      h2 {
        color: #fff;
      }
      #map {
        height: 800px;
        width: 100%;
        max-width: 95%;
        border-radius: 10px;
        margin: 40px auto;
        box-shadow: 0 0 10px rgba(255, 0, 255, 0.2);
      }
      .gm-style img[src$="custommappin.png"] {
        filter: brightness(1.8) contrast(1.2)
          drop-shadow(0 0 3px rgba(255, 0, 255, 0.5));
        transition: filter 0.3s ease;
      }
      .gm-style img[src$="custommappin.png"]:hover {
        filter: brightness(2.2) contrast(1.4)
          drop-shadow(0 0 6px rgba(255, 0, 255, 0.7));
      }
    </style>
  </head>
  <body>
    <div class="p-3">
      <div class="container">
        <div class="row mt-3">
          <div class="col">
            <h2>Regional Trends Map</h2>
            <hr />
            <p class="text-light mb-0" style="font-size: 1rem">
              Explore popular movie purchase trends across your region and
              nearby areas in real time.
            </p>
          </div>
        </div>
      </div>
    </div>

    <div class="content-container">
      <div
        class="search-bar-container"
        style="margin: 0 auto 25px auto; text-align: center"
      >
        <div style="display: inline-flex; align-items: center; gap: 8px">
          <input
            id="location-search"
            type="text"
            placeholder="Search city or country..."
            style="
              width: 320px;
              padding: 10px 15px;
              border: 1.5px solid rgba(255, 0, 255, 0.4);
              border-radius: 25px;
              background: rgba(20, 20, 20, 0.85);
              color: #fff;
              font-size: 0.95rem;
              outline: none;
              box-shadow: 0 0 8px rgba(255, 0, 255, 0.2);
              transition: all 0.3s ease;
            "
            onfocus="this.style.boxShadow='0 0 12px rgba(255, 0, 255, 0.5)'"
            onblur="this.style.boxShadow='0 0 8px rgba(255, 0, 255, 0.2)'"
          />

          <button
            id="search-btn"
            class="btn btn-gradient"
            style="
              background: linear-gradient(90deg, #ff00cc, #7928ca);
              color: #fff;
              font-weight: 600;
              border: none;
              border-radius: 25px;
              padding: 10px 22px;
              font-size: 0.95em;
              cursor: pointer;
              box-shadow: 0 0 10px rgba(255, 0, 255, 0.4);
              transition: all 0.3s ease;
            "
            onmouseover="this.style.boxShadow='0 0 16px rgba(255, 0, 255, 0.6)'"
            onmouseout="this.style.boxShadow='0 0 10px rgba(255, 0, 255, 0.4)'"
          >
            Search
          </button>
        </div>
      </div>
      {% if map_data and map_data|length > 0 %}
      <!-- Dynamic location info -->
      <p id="dynamic-location-info" class="text-light mt-2"></p>

      <!-- Map container -->
      <div id="map"></div>

      <!-- Buttons -->
      <div class="text-center mt-3 ml-3">
        <button
          id="request-location"
          class="btn btn-gradient"
          style="
            background: linear-gradient(90deg, #ff00cc, #7928ca);
            color: #fff;
            font-weight: 600;
            border: none;
            border-radius: 25px;
            padding: 10px 22px;
            font-size: 0.95em;
            cursor: pointer;
            box-shadow: 0 0 10px rgba(255, 0, 255, 0.4);
            transition: all 0.3s ease;
          "
        >
          Share My Location
        </button>

        <button
          id="zoom-my-location"
          class="btn btn-gradient"
          style="
            background: linear-gradient(90deg, #ff00cc, #7928ca);
            color: #fff;
            font-weight: 600;
            border: none;
            border-radius: 25px;
            padding: 10px 22px;
            font-size: 0.95em;
            cursor: pointer;
            box-shadow: 0 0 10px rgba(255, 0, 255, 0.4);
            transition: all 0.3s ease;
          "
        >
          Zoom to My Location
        </button>
      </div>

      <!-- Safely embed map data -->
      {{ map_data|json_script:"map-data" }}

      <script>
        // Global map reference
        window.map = null;
        window.userLocation = null;

        document.addEventListener("DOMContentLoaded", function () {
          const mapData = JSON.parse(
            document.getElementById("map-data").textContent
          );

          /**
           * Initialize the Google Map with optional center.
           * Sets default center if none provided.
           * Applies custom styles and adds markers with InfoWindows.
           */
          function initMap(center) {
            const defaultCenter = { lat: 39.8283, lng: -98.5795 };
            const mapCenter = center || defaultCenter;

            // Create map instance with custom styles and zoom level
            window.map = new google.maps.Map(document.getElementById("map"), {
              zoom: 4,
              center: mapCenter,
              styles: [
                { elementType: "geometry", stylers: [{ color: "#1d2c4d" }] },
                {
                  elementType: "labels.text.fill",
                  stylers: [{ color: "#8ec3b9" }],
                },
                {
                  elementType: "labels.text.stroke",
                  stylers: [{ color: "#1a3646" }],
                },
                {
                  featureType: "water",
                  elementType: "geometry",
                  stylers: [{ color: "#0e1626" }],
                },
              ],
            });

            const bounds = new google.maps.LatLngBounds();
            let openInfoWindow = null;

            // Add markers for each data point with clickable InfoWindows
            mapData.forEach((item) => {
              const position = { lat: item.latitude, lng: item.longitude };
              const marker = new google.maps.Marker({
                position,
                map: window.map,
                title: `${item.movie_title} (${item.total_purchases} purchases)`,
                icon: {
                  url: "/static/img/custommappin.png",
                  scaledSize: new google.maps.Size(50, 50),
                },
              });

              // Create InfoWindow with movie details and poster
              const infoWindow = new google.maps.InfoWindow({
                content: `
                  <div style="background: #1d2c4d; color: #fff; padding: 8px; border-radius: 10px; text-align: center;">
                    <img src="${item.poster_url}" alt="${
                  item.movie_title
                } poster"
                         style="width: 70px; height: auto; border-radius: 8px; margin-bottom: 10px;" />
                    <h6 style="margin: 5px 0;">${item.movie_title}</h6>
                    <p style="margin: 0; font-size: 0.9em; opacity: 0.8;">${
                      item.city
                    }, ${item.state}</p>
                    <p style="font-style: italic; color: #ccc; margin-top: 4px;">${
                      item.total_purchases
                    } purchase${item.total_purchases > 1 ? "s" : ""}</p>
                  </div>`,
              });

              // Open InfoWindow on marker click, closing any previously open window
              marker.addListener("click", () => {
                if (openInfoWindow) openInfoWindow.close();
                infoWindow.open(window.map, marker);
                openInfoWindow = infoWindow;
              });

              bounds.extend(position);
            });

            // Adjust map bounds to fit all markers if data exists
            if (mapData.length > 0) window.map.fitBounds(bounds);
          }

          // Geolocation logic to get user position and update map accordingly
          if (navigator.geolocation) {
            navigator.geolocation.getCurrentPosition(
              (position) => {
                const userLocation = {
                  lat: position.coords.latitude,
                  lng: position.coords.longitude,
                };
                window.userLocation = userLocation;

                // Reverse geocode to get human-readable location name
                const geocoder = new google.maps.Geocoder();
                geocoder.geocode(
                  { location: userLocation },
                  (results, status) => {
                    const infoEl = document.getElementById(
                      "dynamic-location-info"
                    );
                    if (infoEl) {
                      if (status === "OK" && results[0]) {
                        const place =
                          results[0].formatted_address.split(",")[0];
                        infoEl.textContent = `Explore trending movies around ${place}!`;
                      } else {
                        infoEl.textContent =
                          "Explore trending movies near your area!";
                      }
                    }
                  }
                );

                initMap(userLocation);

                // Draw a pulsing circle around user's location
                const circle = new google.maps.Circle({
                  strokeColor: "rgba(138, 43, 226, 0.8)",
                  strokeOpacity: 0.9,
                  strokeWeight: 1.5,
                  fillColor: "rgba(128, 0, 128, 0.25)",
                  fillOpacity: 0.25,
                  map: window.map,
                  center: userLocation,
                  radius: 40000,
                });

                // Animate circle radius and opacity for pulsing effect
                let t = 0;
                function smoothPulse() {
                  t += 0.03;
                  const scale = 1 + 0.05 * Math.sin(t);
                  circle.setRadius(40000 * scale);
                  const opacity = 0.25 + (0.05 * (1 + Math.sin(t))) / 2;
                  circle.setOptions({ fillOpacity: opacity });
                  requestAnimationFrame(smoothPulse);
                }
                smoothPulse();
              },
              () => initMap() // Fallback to default map if geolocation fails
            );
          } else initMap(); // Initialize map without user location if unsupported

          window.initMap = initMap;
        });

        // Handle "Share My Location" button click to request and store location sharing consent
        document.addEventListener("DOMContentLoaded", function () {
          const locationBtn = document.getElementById("request-location");
          if (locationBtn) {
            locationBtn.addEventListener("click", () => {
              if (localStorage.getItem("locationShared") === "true") {
                alert("‚úÖ You've already shared your location.");
                return;
              }
              alert("üìç Getting your location... please wait.");
              if (navigator.geolocation) {
                navigator.geolocation.getCurrentPosition(
                  (pos) => {
                    // Store consent flag and reload page to update map
                    localStorage.setItem("locationShared", "true");
                    alert("‚úÖ Location successfully shared!");
                    window.location.reload();
                  },
                  (err) =>
                    alert(
                      "‚ö†Ô∏è Unable to retrieve location. Please check permissions."
                    ),
                  { enableHighAccuracy: true, timeout: 7000, maximumAge: 60000 }
                );
              } else alert("‚ùå Geolocation not supported.");
            });
          }
        });

        // Handle "Zoom to My Location" button click to smoothly zoom and pan to user's location
        document.addEventListener("DOMContentLoaded", function () {
          const zoomBtn = document.getElementById("zoom-my-location");
          if (zoomBtn) {
            zoomBtn.addEventListener("click", () => {
              if (window.map && window.userLocation) {
                let currentZoom = window.map.getZoom();
                const targetZoom = 8;
                // Increment zoom gradually for smooth zoom effect
                const zoomInterval = setInterval(() => {
                  if (currentZoom < targetZoom) {
                    currentZoom += 0.5;
                    window.map.setZoom(currentZoom);
                  } else clearInterval(zoomInterval);
                }, 100);
                window.map.panTo(window.userLocation);
              } else alert("‚ö†Ô∏è Please share your location first!");
            });
          }
        });
        // Search bar functionality: geocode input and center map on result
        document.addEventListener("DOMContentLoaded", function () {
          const searchBtn = document.getElementById("search-btn");
          const searchInput = document.getElementById("location-search");

          if (searchBtn && searchInput) {
            searchBtn.addEventListener("click", () => {
              const query = searchInput.value.trim();
              if (!query) return alert("Please enter a city or country.");

              const geocoder = new google.maps.Geocoder();
              geocoder.geocode({ address: query }, (results, status) => {
                if (status === "OK" && results[0]) {
                  const location = results[0].geometry.location;
                  window.map.setCenter(location);

                  // Adjust zoom dynamically based on whether location is a country or city
                  const addressComponents = results[0].address_components;
                  const isCountry = addressComponents.some((comp) =>
                    comp.types.includes("country")
                  );
                  const zoomLevel = isCountry ? 5 : 9;
                  window.map.setZoom(zoomLevel);
                } else {
                  alert("‚ö†Ô∏è Location not found. Try again.");
                }
              });
            });
          }
        });
      </script>

      <script
        async
        defer
        src="https://maps.googleapis.com/maps/api/js?key={{ MAPS_JS_API_KEY }}&callback=initMap"
      ></script>

      {% else %}
      <p class="no-data-message">
        No regional purchase data available to display on the map.
      </p>
      {% endif %}
    </div>
  </body>
</html>
{% endblock %}
